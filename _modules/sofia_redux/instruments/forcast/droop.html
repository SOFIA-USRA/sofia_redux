<!DOCTYPE html>

<html lang="en" data-content_root="../../../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>sofia_redux.instruments.forcast.droop &#8212; sofia_redux v1.3.4.dev38+g92ea2f4</title>
    <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/bootstrap-sofia.css?v=3fe2c07e" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/graphviz.css?v=eafc0fe6" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/plot_directive.css" />
    
    <script src="../../../../_static/jquery.js?v=5d32c60e"></script>
    <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
    <script src="../../../../_static/documentation_options.js?v=6aa39468"></script>
    <script src="../../../../_static/doctools.js?v=888ff710"></script>
    <script src="../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script type="text/javascript" src="../../../../_static/sidebar.js"></script>
    <script type="text/javascript" src="../../../../_static/copybutton.js"></script>
    <link rel="icon" href="../../../../_static/redux.ico"/>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
    <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:200,600' rel='stylesheet' type='text/css'/>

  </head><body>
<div class="topbar">
  <a class="brand" title="Documentation Home" href="../../../../index.html"><span id="logotext1">SOFIA</span><span id="logotext2">Redux</span><span id="logotext3">:docs</span></a>
  <ul>
    <li><a class="homelink" title="SOFIA Homepage" href="https://irsa.ipac.caltech.edu/Missions/sofia.html"></a></li>
    <li><a title="General Index" href="../../../../genindex.html">Index</a></li>
    <li><a title="Module Index" href="../../../../py-modindex.html">Modules</a></li>
    <li>
      
      
<form action="../../../../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
      
    </li>
  </ul>
</div>

<div class="related">
    <h3>Navigation</h3>
    <ul>
      <li>
	<a href="../../../../index.html">sofia_redux v1.3.4.dev38+g92ea2f4</a>
	 &#187;
      </li>
      <li><a href="../../../index.html" accesskey="U">Module code</a> &#187;</li>
      
       
    </ul>
</div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for sofia_redux.instruments.forcast.droop</h1><div class="highlight"><pre>
<span></span># Licensed under a 3-clause BSD style license - see LICENSE.rst

from astropy import log
from astropy.io.fits.header import Header
import numpy as np

from sofia_redux.toolkit.utilities.fits import add_history_wrap

from sofia_redux.instruments.forcast.getpar import getpar

addhist = add_history_wrap(&#39;Droop&#39;)

__all__ = [&#39;droop&#39;]


<div class="viewcode-block" id="droop">
<a class="viewcode-back" href="../../../../api/sofia_redux.instruments.forcast.droop.droop.html#sofia_redux.instruments.forcast.droop.droop">[docs]</a>
def droop(data, header=None, frac=None, variance=None):
    &quot;&quot;&quot;
    Corrects droop electronic signal

    The FORCAST arrays and readout electronics exhibit a linear
    response offset caused by he presence of a signal on the array.
    This effect is called &quot;droop&quot; since the result is a reduced
    signal that is proportional to the total signal in the 15 other
    pixels in row read from the multiplexer simultaneously with
    that pixel.  The droop correction removes the droop offset by
    multiplying each pixel by a value derived from the sum of
    every 16th pixel in the same row all multiplied by an empirically
    determined offset fraction: droopfrac = 0.0035.

    Parameters
    ----------
    data : numpy.ndarray
        Input dara array (nimage, nrow, ncol)
    header : astropy.io.fits.header.Header, optional
        Input FITS header; will be updated with a HISTORY message
    frac : float, optional
        Channel suppression correction factor.  If this keyword
        is not set, the configuration file will be checked for the
        key FRACDROOP.  If not found, the default value of 0.0035
        will be used.
    variance : numpy.ndarray, optional
        Variance array (nimage, nrow, ncol) to update in parallel
        with the data array.  Note that, for now, it is assumed that
        there is no error in the droop correction.  If variance is
        passed, it will be returned unmodified.

    Returns
    -------
    numpy.ndarray, numpy.ndarray
        The droop corrected array (nimage, nrow, ncol) or (nrow, ncol)
        propagated variance (nimage, nrow, ncol) or (nrow, ncol)
    &quot;&quot;&quot;
    if not isinstance(header, Header):
        header = Header()
        addhist(header, &#39;Created header&#39;)

    if not isinstance(data, np.ndarray) or len(data.shape) not in [2, 3]:
        addhist(header, &#39;Droop not corrected (invalid data)&#39;)
        log.error(&#39;invalid data&#39;)
        return

    dovar = variance is not None and variance.shape == data.shape
    var = variance.copy() if dovar else None
    if variance is not None and not dovar:
        addhist(header, &#39;Not propagating variance (invalid variance)&#39;)
        log.error(&#39;invalid variance&#39;)

    if frac is None:
        frac = getpar(header, &#39;FRACDROOP&#39;, dtype=float, default=0.0035,
                      comment=&#39;fraction for droop correction&#39;)

    minval = getpar(header, &#39;MINDROOP&#39;, dtype=float, default=0, warn=True,
                    comment=&#39;minimum value for droop correction&#39;)
    maxval = getpar(header, &#39;MAXDROOP&#39;, dtype=float, default=-65535, warn=True,
                    comment=&#39;maximum value for droop correction&#39;)
    nreadouts = getpar(header, &#39;NRODROOP&#39;, dtype=int, default=16, warn=True,
                       comment=&#39;number of rows for droop correction&#39;)

    # Put into cast friendly format
    ndim = len(data.shape)
    corr = np.array([data.copy()]) if ndim == 2 else data.copy()
    corr = corr.astype(&#39;float64&#39;)

    # for each row, add a correction to each chunk of &lt;nreadouts&gt; pixels
    # based on a fraction of their sum
    nsets = int(data.shape[-1] / nreadouts)  # readouts per row
    for i in range(nsets):
        x1, x2 = i * nreadouts, (i + 1) * nreadouts
        section = corr[:, :, x1: x2]
        section += frac * np.nansum(section, axis=2, keepdims=True)

    # Ensure corrected values lie within (minval, maxval)
    finite = ~np.isnan(corr)
    low, high = finite.copy(), finite.copy()
    low[low] &amp;= corr[low] &lt; minval
    high[high] &amp;= corr[high] &gt; maxval
    corr[low] = minval
    corr[high] = maxval

    # Put back to original format
    corr = corr.astype(data.dtype)
    if ndim == 2:
        corr = corr[0]

    addhist(header, &#39;Applied channel suppression (droop) correction&#39;)
    addhist(header, &#39;Channel suppression correction factor %f&#39; % frac)

    return corr, var</div>

</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><h3>Page Contents</h3>


        </div>
      </div>
      <div class="clearer"></div>
    </div>
<footer class="footer">
  <p class="pull-right"> &nbsp;
    <a href="#">Back to Top</a></p>
  <p>
    &copy; Copyright 2024, SOFIA-USRA.<br/>
    Created using <a href="http://www.sphinx-doc.org/en/stable/">Sphinx</a> 7.2.6. &nbsp;
    Last built 05 Feb 2024. <br/>
  </p>
</footer>
  </body>
</html>