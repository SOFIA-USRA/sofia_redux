<!DOCTYPE html>

<html lang="en" data-content_root="../../../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>sofia_redux.instruments.exes.cirrus &#8212; sofia_redux v1.3.4.dev38+g92ea2f4</title>
    <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/bootstrap-sofia.css?v=3fe2c07e" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/graphviz.css?v=eafc0fe6" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/plot_directive.css" />
    
    <script src="../../../../_static/jquery.js?v=5d32c60e"></script>
    <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
    <script src="../../../../_static/documentation_options.js?v=6aa39468"></script>
    <script src="../../../../_static/doctools.js?v=888ff710"></script>
    <script src="../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script type="text/javascript" src="../../../../_static/sidebar.js"></script>
    <script type="text/javascript" src="../../../../_static/copybutton.js"></script>
    <link rel="icon" href="../../../../_static/redux.ico"/>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
    <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:200,600' rel='stylesheet' type='text/css'/>

  </head><body>
<div class="topbar">
  <a class="brand" title="Documentation Home" href="../../../../index.html"><span id="logotext1">SOFIA</span><span id="logotext2">Redux</span><span id="logotext3">:docs</span></a>
  <ul>
    <li><a class="homelink" title="SOFIA Homepage" href="https://irsa.ipac.caltech.edu/Missions/sofia.html"></a></li>
    <li><a title="General Index" href="../../../../genindex.html">Index</a></li>
    <li><a title="Module Index" href="../../../../py-modindex.html">Modules</a></li>
    <li>
      
      
<form action="../../../../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
      
    </li>
  </ul>
</div>

<div class="related">
    <h3>Navigation</h3>
    <ul>
      <li>
	<a href="../../../../index.html">sofia_redux v1.3.4.dev38+g92ea2f4</a>
	 &#187;
      </li>
      <li><a href="../../../index.html" accesskey="U">Module code</a> &#187;</li>
      
       
    </ul>
</div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for sofia_redux.instruments.exes.cirrus</h1><div class="highlight"><pre>
<span></span># Licensed under a 3-clause BSD style license - see LICENSE.rst

from astropy import log
import numpy as np

from sofia_redux.instruments.exes import utils

__all__ = [&#39;cirrus&#39;]


<div class="viewcode-block" id="cirrus">
<a class="viewcode-back" href="../../../../api/sofia_redux.instruments.exes.cirrus.cirrus.html#sofia_redux.instruments.exes.cirrus.cirrus">[docs]</a>
def cirrus(data, header, abeams, bbeams, flat):
    &quot;&quot;&quot;
    Correct nod-off-slit data for residual sky noise.

    Remove sky noise by subtracting (a + by) * B + (c + dy) / flat from A,
    where B is the sky nod array, A is the source array, and a, b, c, d
    are chosen to minimize the sum of (A - B)^2.

    Note that sky noise depends on y because clouds can vary during an
    array readout.

    This algorithm removes the average continuum along the slit.
    If this is not desired, background subtraction should be done during
    spectral extraction instead.

    Parameters
    ----------
    data : numpy.ndarray
        Data cube of shape (nframe, nspec, nspat) or image (nspec, nspat).
    header : fits.Header
        Header associated with the input data.
    abeams : `list` of int
        List of frame indices corresponding to A frames in the data cube.
    bbeams : `list` of int
        List of frame indices corresponding to B frames in the data cube.
    flat : numpy.ndarray
        Flat image of shape (nspec, nspat).

    Returns
    -------
    data : numpy.ndarray
        The corrected data.
    &quot;&quot;&quot;
    nx = header[&#39;NSPAT&#39;]
    ny = header[&#39;NSPEC&#39;]

    try:
        nz = utils.check_data_dimensions(data=data, nx=nx, ny=ny)
    except RuntimeError:
        log.error(f&#39;Data has wrong dimensions {data.shape}. &#39;
                  f&#39;Not correcting background.&#39;)
        return data

    try:
        _check_beams(abeams, bbeams, nz)
    except RuntimeError:
        log.error(&#39;A and B beams must be specified and number &#39;
                  &#39;must match. Not correcting background.&#39;)
        return data

    log.info(&#39;Subtracting sky fluctuations in cirrus&#39;)
    log.warning(&#39;This algorithm removes average continuum along slit. &#39;
                &#39;Use background subtraction during spectral extraction &#39;
                &#39;if this is not desired.&#39;)

    # Make index array to get distance from center
    y, x = np.mgrid[0:ny, 0:nx]
    xny2 = (ny + 1) / 2
    dy = (y - xny2) / ny

    # Initialize
    alpha = np.zeros((4, 4))
    beta = np.zeros(4)
    corrected = np.zeros((nz, ny, nx))
    xpar = np.zeros((4, ny, nx))

    # Get correctable points from flat
    z = flat &gt; 0
    if np.sum(z) == 0:
        log.error(&#39;No good points in flat.&#39;)
        return data

    for k in range(int(nz / 2)):

        # Get A and B data
        adata = data[abeams[k]]
        bdata = data[bbeams[k]]

        # Find sky noise parameters
        # Set to zero where flat is bad (so no contribution to sum)
        xpar[0][z] = bdata[z]
        xpar[1][z] = bdata[z] * dy[z]
        xpar[2][z] = 1 / flat[z]
        xpar[3][z] = dy[z] / flat[z]

        for i in range(4):
            for j in range(4):
                alpha[i, j] = np.nansum(xpar[i] * xpar[j])
            beta[i] = np.nansum((adata - bdata) * xpar[i])

        try:
            inv_alpha = np.linalg.inv(alpha)
        except np.linalg.LinAlgError:
            log.warning(&#39;Could not find sky parameters. &#39;
                        &#39;Not correcting background.&#39;)
            return data
        alpha = inv_alpha

        a = np.zeros(4)
        for i in range(4):
            a[i] = np.nansum(beta * alpha[i])

        log.info(f&#39;Sky noise parameters for pair {k+1}: &#39;)
        log.info(a)

        # Correct A beam
        adata[z] = (adata[z] - (a[0] + a[1] * dy[z]) * bdata[z]
                    - (a[2] + a[3] * dy[z]) / flat[z])
        corrected[abeams[k]] = adata
        corrected[bbeams[k]] = bdata

    return corrected</div>



def _check_beams(abeams, bbeams, nz):
    if (len(abeams) == 0
            or len(bbeams) == 0
            or len(abeams) != len(bbeams)
            or len(abeams) != nz // 2):
        raise RuntimeError
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><h3>Page Contents</h3>


        </div>
      </div>
      <div class="clearer"></div>
    </div>
<footer class="footer">
  <p class="pull-right"> &nbsp;
    <a href="#">Back to Top</a></p>
  <p>
    &copy; Copyright 2024, SOFIA-USRA.<br/>
    Created using <a href="http://www.sphinx-doc.org/en/stable/">Sphinx</a> 7.2.6. &nbsp;
    Last built 05 Feb 2024. <br/>
  </p>
</footer>
  </body>
</html>