<!DOCTYPE html>

<html lang="en" data-content_root="../../../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>sofia_redux.instruments.flitecam.backsub &#8212; sofia_redux v1.3.4.dev38+g92ea2f4</title>
    <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/bootstrap-sofia.css?v=3fe2c07e" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/graphviz.css?v=eafc0fe6" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/plot_directive.css" />
    
    <script src="../../../../_static/jquery.js?v=5d32c60e"></script>
    <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
    <script src="../../../../_static/documentation_options.js?v=6aa39468"></script>
    <script src="../../../../_static/doctools.js?v=888ff710"></script>
    <script src="../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script type="text/javascript" src="../../../../_static/sidebar.js"></script>
    <script type="text/javascript" src="../../../../_static/copybutton.js"></script>
    <link rel="icon" href="../../../../_static/redux.ico"/>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
    <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:200,600' rel='stylesheet' type='text/css'/>

  </head><body>
<div class="topbar">
  <a class="brand" title="Documentation Home" href="../../../../index.html"><span id="logotext1">SOFIA</span><span id="logotext2">Redux</span><span id="logotext3">:docs</span></a>
  <ul>
    <li><a class="homelink" title="SOFIA Homepage" href="https://irsa.ipac.caltech.edu/Missions/sofia.html"></a></li>
    <li><a title="General Index" href="../../../../genindex.html">Index</a></li>
    <li><a title="Module Index" href="../../../../py-modindex.html">Modules</a></li>
    <li>
      
      
<form action="../../../../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
      
    </li>
  </ul>
</div>

<div class="related">
    <h3>Navigation</h3>
    <ul>
      <li>
	<a href="../../../../index.html">sofia_redux v1.3.4.dev38+g92ea2f4</a>
	 &#187;
      </li>
      <li><a href="../../../index.html" accesskey="U">Module code</a> &#187;</li>
      
       
    </ul>
</div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for sofia_redux.instruments.flitecam.backsub</h1><div class="highlight"><pre>
<span></span># Licensed under a 3-clause BSD style license - see LICENSE.rst

from astropy import log
from astropy.io import fits
import numpy as np

from sofia_redux.toolkit.utilities.fits import hdinsert

__all__ = [&#39;backsub&#39;]


<div class="viewcode-block" id="backsub">
<a class="viewcode-back" href="../../../../api/sofia_redux.instruments.flitecam.backsub.backsub.html#sofia_redux.instruments.flitecam.backsub.backsub">[docs]</a>
def backsub(hdul, bgfile=None, method=&#39;flatnorm&#39;):
    &quot;&quot;&quot;
    Correct flux data for background level.

    To correct pixels individually, a background image must be
    provided with a FLUX extension and (optionally) an ERROR extension.
    The error is propagated assuming that the input data is independent
    of the sky data. Delete the extension or set the error plane to
    zero-values to skip error propagation.

    Otherwise, a single background level can be determined from the
    median of each image, or from a header value derived from a
    sky flat file, stored in the FLATNORM keyword in the primary header
    of the input data.  In this case, no error is propagated.

    Parameters
    ----------
    hdul : fits.HDUList
        Input data. Should have FLUX, ERROR, FLAT, and FLAT_ERROR
        extensions.
    bgfile : fits.HDUList, optional
        Background image. Should have FLUX and ERROR extensions.
    method : {&#39;flatnorm&#39;, &#39;median&#39;}, optional
        Method for background value determination, if background image
        is not provided.  If &#39;flatnorm&#39;, the header keyword FLATNORM
        will be subtracted from the data. If &#39;median&#39;, the image median
        will be subtracted from the data. Ignored if `bgfile` is not
        None.

    Returns
    -------
    fits.HDUList
        Corrected data, with updated FLUX and ERROR extensions.
    &quot;&quot;&quot;
    # input data
    header = hdul[0].header
    flux = hdul[&#39;FLUX&#39;].data
    var = hdul[&#39;ERROR&#39;].data ** 2

    if bgfile is not None:
        bgdata = bgfile[&#39;FLUX&#39;].data
        if &#39;ERROR&#39; in bgfile:
            bgvar = bgfile[&#39;ERROR&#39;].data ** 2
        else:
            bgvar = 0.0

        corrected_flux = flux - bgdata
        corrected_var = var + bgvar

        # record method and value
        hdinsert(header, &#39;BGSOURCE&#39;,
                 bgfile[0].header.get(&#39;FILENAME&#39;, &#39;UNKNOWN&#39;),
                 &#39;Background value source&#39;)
        hdinsert(header, &#39;BGVALUE&#39;, np.nanmedian(bgdata),
                 &#39;Median background value&#39;)
    else:
        if method == &#39;flatnorm&#39;:
            bgval = hdul[0].header.get(&#39;FLATNORM&#39;, None)
            if bgval is None:
                log.warning(&#39;FLATNORM keyword is missing; background &#39;
                            &#39;will not be corrected.&#39;)
                bgval = 0
            hdinsert(header, &#39;BGSOURCE&#39;, &#39;FLATNORM keyword&#39;,
                     &#39;Background value source&#39;)
        else:
            bgval = np.nanmedian(flux)
            hdinsert(header, &#39;BGSOURCE&#39;, &#39;Image median&#39;,
                     &#39;Background value source&#39;)

        corrected_flux = flux - bgval
        corrected_var = var
        hdinsert(header, &#39;BGVALUE&#39;, bgval, &#39;Median background value&#39;)

    # make output hdul
    corrected = fits.HDUList()
    expected = [&#39;FLUX&#39;, &#39;ERROR&#39;, &#39;BADMASK&#39;, &#39;EXPOSURE&#39;]
    for hdu in hdul:
        if hdu.name in expected:
            corrected.append(hdu)

    corrected[&#39;FLUX&#39;].data = corrected_flux
    corrected[&#39;ERROR&#39;].data = np.sqrt(corrected_var)

    return corrected</div>

</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><h3>Page Contents</h3>


        </div>
      </div>
      <div class="clearer"></div>
    </div>
<footer class="footer">
  <p class="pull-right"> &nbsp;
    <a href="#">Back to Top</a></p>
  <p>
    &copy; Copyright 2024, SOFIA-USRA.<br/>
    Created using <a href="http://www.sphinx-doc.org/en/stable/">Sphinx</a> 7.2.6. &nbsp;
    Last built 05 Feb 2024. <br/>
  </p>
</footer>
  </body>
</html>